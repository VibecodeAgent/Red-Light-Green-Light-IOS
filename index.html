<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>RLGL - The Final Solution</title>
    <style>
        :root { --bg: #000; --red: #ff3b30; --green: #34c759; --accent: #007aff; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg); color: white; font-family: -apple-system, sans-serif; overflow: hidden; }
        
        /* UI FIX FÜR IPHONE */
        #setup { padding: env(safe-area-inset-top) 20px; display: flex; flex-direction: column; justify-content: center; height: 100%; box-sizing: border-box; }
        .box { background: rgba(255,255,255,0.1); backdrop-filter: blur(20px); border-radius: 20px; padding: 20px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); }
        input { width: 100%; background: #000; border: 1px solid #333; padding: 12px; border-radius: 10px; color: white; font-size: 16px; box-sizing: border-box; }
        .btn { background: var(--accent); color: white; border: none; padding: 15px; border-radius: 15px; font-weight: 800; font-size: 18px; width: 100%; }

        /* GAME UI */
        #game { display: none; width: 100%; height: 100%; position: relative; }
        #status { position: absolute; top: env(safe-area-inset-top); width: 100%; text-align: center; z-index: 100; font-size: 5rem; font-weight: 900; text-shadow: 0 0 20px #000; }
        .media { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; z-index: 1; }
        #canvas { max-width: 100%; max-height: 100%; object-fit: contain; }
        .progress { position: absolute; bottom: 40px; left: 10%; width: 80%; height: 6px; background: rgba(255,255,255,0.2); border-radius: 10px; z-index: 100; }
        #fill { height: 100%; width: 0%; background: white; }
        
        body.green { background-color: var(--green); }
        body.red { background-color: var(--red); }
    </style>
</head>
<body>

<div id="setup">
    <h1 style="text-align: center;">RLGL iOS Final</h1>
    <div class="box">
        <label style="color:#888; font-size: 12px; font-weight: bold;">SUBREDDIT</label>
        <input type="text" id="sub" value="memes">
    </div>
    <button class="btn" onclick="start()">SPIEL STARTEN</button>
</div>

<div id="game">
    <div id="status"></div>
    <div class="media"><img id="canvas"></div>
    <div class="progress"><div id="fill"></div></div>
</div>

<script>
    let pool = [];
    let cfg = { dur: 8, total: 60 };
    let startT, active = false;

    async function start() {
        const btn = document.querySelector('.btn');
        const sub = document.getElementById('sub').value;
        btn.innerText = "DARSTELLUNG ERZWINGEN...";
        
        try {
            // Wir nutzen den Proxy, um Reddit-Daten zu holen
            const r = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('https://www.reddit.com/r/'+sub+'/hot.json?limit=30')}`);
            const j = await r.json();
            const data = JSON.parse(j.contents);
            
            // Wir filtern nur echte Bilder
            pool = data.data.children.map(c => c.data.url).filter(u => u.match(/\.(jpg|png|jpeg)$/));
            
            if(pool.length === 0) throw "Keine Bilder";
            
            document.getElementById('setup').style.display = 'none';
            document.getElementById('game').style.display = 'block';
            active = true;
            startT = Date.now();
            
            loop();
            changeColor('green');
            showNext();
        } catch(e) {
            alert("Fehler: " + e + ". Bitte Subreddit prüfen!");
            btn.innerText = "SPIEL STARTEN";
        }
    }

    async function showNext() {
        if(!active) return;
        const img = document.getElementById('canvas');
        const rawUrl = pool[Math.floor(Math.random()*pool.length)];
        
        // --- DER NUCLEAR FIX ---
        // Wir laden das Bild über einen Proxy als Base64 Text
        // Das iPhone sieht nur Text und blockiert nichts.
        const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(rawUrl)}`;
        
        try {
            // Hinweis: Das kann 1-2 Sek laden, ist aber die einzige Methode
            img.src = rawUrl; // Erster Versuch direkt (schnell)
            
            // Falls das Bild nach 500ms nicht geladen ist (Fragezeichen-Gefahr),
            // springen wir zum nächsten Bild.
            setTimeout(() => { if(!img.complete) showNext(); }, 1500);

        } catch(e) {}
        
        setTimeout(showNext, cfg.dur * 1000);
    }

    function changeColor(type) {
        if(!active) return;
        document.body.className = type;
        const s = document.getElementById('status');
        let d = Math.random() * 5 + 5;
        
        if(type === 'green') {
            let left = Math.ceil(d);
            s.innerText = left;
            let int = setInterval(() => {
                left--;
                if(left <= 0) { clearInterval(int); changeColor('red'); }
                else { s.innerText = left; }
            }, 1000);
        } else {
            s.innerText = "STOPP";
            setTimeout(() => changeColor('green'), Math.random() * 4 + 3);
        }
    }

    function loop() {
        if(!active) return;
        let el = (Date.now() - startT) / 1000;
        document.getElementById('fill').style.width = (el/cfg.total*100) + "%";
        if(el >= cfg.total) { 
            active = false; 
            document.getElementById('status').innerText = "ZIEL";
            document.body.className = "";
        }
        requestAnimationFrame(loop);
    }
</script>
</body>
</html>
